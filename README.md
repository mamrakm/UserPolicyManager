__NOTE__: parts of the code were generated by LLM (Claude 3.7). Ultimately using the LLM has proven to be a mistake, as
it
generated code that was not working or had really sneaky mistakes. I had to fix it manually. Javadoc and README.md were
written by LLM as well as simple things like DTOs.

# User Policy Manager

A Spring Boot REST application for managing users and policies with PostgreSQL persistence.

## Overview

This application provides a robust system for managing users and applying policies based on configurable rules. Each
policy defines one or more conditions that determine if it applies to a user. When a policy is applicable to a user, it
is added to the user's policy array.

## Requirements

**Important**: This project requires Java 21 to run. It uses modern Java features including record patterns, sealed
interfaces, and enhanced pattern matching.

## Features

- **User Management**: Create, read, update, and delete user profiles
- **Policy Configuration**: Define rules that target specific users based on attributes
- **Automatic Policy Evaluation**: Real-time policy evaluation and application
- **RESTful API**: Well-defined endpoints for integration
- **PostgreSQL Storage**: Data persistence using JPA and PostgreSQL
- **Event-driven Architecture**: Uses Spring events for policy evaluation

## Technologies

- Java 21
- Spring Boot 3.2.5
- Spring Data JPA
- PostgreSQL
- Lombok
- Docker & Docker Compose

## Getting Started

### Prerequisites

- JDK 21 or higher
- Maven 3.8.0 or higher
- Docker and Docker Compose

### Running the Application

The easiest way to run the application is using Docker Compose:

1. Build the application Docker image:

```bash
# Give execute permissions to the build script
chmod +x build.sh

# Build the application and Docker image
./build.sh
```

2. Start the application with Docker Compose:

```bash
# Give execute permissions to the run script
chmod +x run.sh

# Start the application and PostgreSQL
./run.sh
```

3. The API will be available at http://localhost:8080

### Stopping the Application

```bash
docker-compose down
```

## API Endpoints

### User API

| Method | Endpoint            | Description             |
|--------|---------------------|-------------------------|
| GET    | `/api/users`        | Get all users           |
| GET    | `/api/users/{name}` | Get user by name        |
| POST   | `/api/users`        | Create a new user       |
| PUT    | `/api/users/{name}` | Update an existing user |
| DELETE | `/api/users/{name}` | Delete a user           |

### Policy API

| Method | Endpoint             | Description               |
|--------|----------------------|---------------------------|
| GET    | `/api/policies`      | Get all policies          |
| GET    | `/api/policies/{id}` | Get policy by ID          |
| POST   | `/api/policies`      | Create a new policy       |
| PUT    | `/api/policies/{id}` | Update an existing policy |
| DELETE | `/api/policies/{id}` | Delete a policy           |

## Examples

### User Object

```json
{
  "name": "jdoe",
  "firstName": "John",
  "lastName": "Doe",
  "emailAddress": "jdoe@evolveum.com",
  "organizationUnit": [
    "Software Development",
    "Support"
  ],
  "birthDate": "2007-09-07",
  "registeredOn": "2024-05-07",
  "policy": [
    "underaged",
    "internal-user",
    "developer-full-access"
  ]
}
```

### Policy Objects

```json
{
  "id": "underaged",
  "name": "Underaged User",
  "youngerThan": {
    "value": 18
  }
}
```

```json
{
  "id": "internal-user",
  "name": "Internal User",
  "emailDomainIs": {
    "value": "evolveum.com"
  }
}
```

```json
{
  "id": "developer-full-access",
  "name": "Developer (Full Access)",
  "isMemberOf": {
    "value": "Software Development"
  }
}
```

## Architecture

The application follows a clean architecture with the following components:

1. **Domain Models**: JPA entities representing users and policies
2. **Repositories**: Spring Data JPA repositories for data access
3. **Services**: Business logic components
4. **Controllers**: REST API endpoints
5. **Events**: Spring events for policy evaluation
6. **Utility Classes**: Deserializers and helpers

## Database Schema

The application automatically creates the following tables:

- `users`: Stores user information
- `user_organization_units`: Stores user organization memberships
- `user_policies`: Stores policies applied to users
- `policies`: Stores policy definitions